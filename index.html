<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Queer Journal</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#d53369">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
  <link rel="icon" sizes="32x32" href="./favicon-32x32.png" />
  <link rel="icon" sizes="16x16" href="./favicon-16x16.png" />

  <!-- Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" />

  <style>
    :root{
      --brand1:#d53369;--brand2:#daae51;
      --btn1:#6a11cb;--btn2:#2575fc;
      --bg:#fafafa;--text:#222;--card:#fff;--muted:#666;--line:#e8e8e8;
      --bg-dark:#121212;--text-dark:#eee;--card-dark:#1f1f1f;--line-dark:#2a2a2a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Quicksand',sans-serif;background:var(--bg);color:var(--text);transition:.25s}
    body.dark{background:var(--bg-dark);color:var(--text-dark)}
    header{display:flex;align-items:center;justify-content:space-between;padding:.9rem 1rem;background:linear-gradient(90deg,var(--brand1),var(--brand2));color:#fff}
    header h1{margin:0;font-size:1.2rem}
    .actions{display:flex;align-items:center;gap:.5rem}
    .toggle-dark{cursor:pointer;background:rgba(255,255,255,.2);border:0;border-radius:999px;min-width:36px;height:36px;color:#fff;padding:0 10px}
    .user-chip{display:flex;align-items:center;gap:.5rem}
    .user-chip img{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,.6)}
    .user-chip small{opacity:.9}

    main{padding:1rem;display:grid;gap:1rem;max-width:920px;margin:0 auto}
    .card{background:var(--card);border-radius:12px;padding:1rem;box-shadow:0 3px 8px rgba(0,0,0,.08);border:1px solid var(--line)}
    body.dark .card{background:var(--card-dark);border-color:var(--line-dark)}
    .row{display:flex;gap:.5rem;flex-wrap:wrap}
    label{display:inline-flex;align-items:center;gap:.4rem;margin:.25rem 0}
    input,select,textarea,button{font:inherit}
    input,select,textarea{width:100%;padding:.55rem .7rem;border-radius:.7rem;border:1px solid var(--line);background:inherit;color:inherit}
    textarea{min-height:120px}
    .pill{border-radius:999px;border:0;background:linear-gradient(90deg,var(--btn1),var(--btn2));color:#fff;padding:.5rem 1rem;cursor:pointer}
    .pill.secondary{background:#ccc;color:#222}
    .gbtn{background:#fff;color:#222;border:1px solid var(--line);display:inline-flex;align-items:center;gap:.5rem}
    .gbtn img{width:18px;height:18px}
    .badge{display:inline-block;padding:.15rem .5rem;border-radius:999px;border:1px solid var(--line);font-size:.8rem;margin-right:.25rem}
    .thumb{max-width:120px;border-radius:.5rem;display:block;margin-top:.5rem}
    .muted{color:var(--muted)}
    footer{position:fixed;bottom:0;left:0;right:0;background:#eee;border-top:1px solid var(--line)}
    body.dark footer{background:#1e1e1e;border-color:var(--line-dark)}
    .tabs{max-width:920px;margin:0 auto;display:flex;gap:.25rem;padding:.4rem}
    .tab{flex:1;background:transparent;border:0;padding:.6rem 0;cursor:pointer;color:inherit;border-bottom:2px solid transparent}
    .tab.active{font-weight:600;border-color:var(--brand1)}
    .entry{border:1px solid var(--line);padding:.8rem;border-radius:.75rem;margin:.5rem 0}
    body.dark .entry{border-color:var(--line-dark)}
    .emoji{font-size:1.15rem;margin-right:.35rem}
    .empty{padding:.6rem 0}
    .spacer{height:72px}
  </style>
</head>
<body>
  <script>
    /* St√§da ev. gammalt PIN-l√•s fr√•n √§ldre versioner */
    try { ['qj.pin','qj.salt','qj.attempts'].forEach(k => localStorage.removeItem(k)); } catch {}
  </script>

  <header>
    <h1>üåà Queer Journal</h1>
    <div class="actions">
      <div class="user-chip" id="userChip" style="display:none">
        <img id="userPhoto" alt="">
        <small id="userName"></small>
      </div>
      <button id="logoutTop" class="toggle-dark" title="Logga ut" style="display:none">üö™</button>
      <button id="darkToggle" class="toggle-dark" title="Byt tema">üåì</button>
    </div>
  </header>

  <main>
    <!-- AUTH -->
    <section id="authSection" class="card">
      <h2>Logga in / Skapa konto</h2>
      <p class="muted">Dina anteckningar sparas privat i molnet och synkas mellan enheter.</p>
      <input id="emailInput" type="email" placeholder="E-post" />
      <input id="passwordInput" type="password" placeholder="L√∂senord" />
      <div class="row">
        <button id="resetBtn" class="pill secondary">Gl√∂mt l√∂senord</button>
        <button id="loginBtn" class="pill">Logga in</button>
        <button id="registerBtn" class="pill secondary">Skapa konto</button>
        <button id="googleBtn" class="pill gbtn">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt=""> Google
        </button>
        <button id="logoutBtn" class="pill" style="display:none">Logga ut</button>
      </div>
    </section>

    <!-- NEW NOTE -->
    <section id="noteSection" class="card" style="display:none">
      <h2>Ny anteckning</h2>
      <div class="row">
        <label style="flex:1">Datum <input id="dateInput" type="date" /></label>
        <label style="flex:1">Tid <input id="timeInput" type="time" /></label>
      </div>
      <label><input id="alarmCheck" type="checkbox" /> ‚è∞ St√§ll alarm</label>
      <div class="row">
        <label style="flex:1">K√§nsla
          <select id="moodInput">
            <option value="">--</option>
            <option>üòä Lugn</option>
            <option>üî• Taggad</option>
            <option>üò¢ Ledsen</option>
            <option>üåà Proud</option>
          </select>
        </label>
        <label style="flex:1">Taggar <input id="tagsInput" type="text" placeholder="t.ex. skola, katt" /></label>
      </div>
      <label>Inneh√•ll
        <textarea id="contentInput" placeholder="t.ex. 1/2 p√•se bl√∂tmat"></textarea>
      </label>
      <label for="imageInput">Bild (valfritt)</label>
      <input id="imageInput" type="file" accept="image/*" />
      <div class="row" style="margin-top:.6rem">
        <button id="saveBtn" class="pill">Spara</button>
        <button id="clearBtn" class="pill secondary">Rensa</button>
      </div>
    </section>

    <!-- NOTES LIST -->
    <section id="notesSection" class="card" style="display:none">
      <h2>Mina anteckningar</h2>
      <div id="notesList" class="empty">Inga anteckningar √§nnu.</div>
    </section>

    <!-- ADMIN -->
    <section id="adminMenu" class="card" style="display:none">
      <h2>Adminpanel</h2>
      <p class="muted">Endast f√∂r superadmin.</p>
      <div class="row">
        <button id="btnWarn" class="pill secondary">‚ö†Ô∏è Skicka varning</button>
        <button id="btnBlock" class="pill">üö´ Blockera anv√§ndare</button>
      </div>
      <div id="adminOut" class="muted" style="margin-top:.75rem;font-size:.9rem"></div>
    </section>
  </main>

  <div class="spacer"></div>

  <footer>
    <div class="tabs">
      <button id="listViewBtn" class="tab active">Lista</button>
      <button id="dayViewBtn" class="tab">Dag</button>
      <button id="weekViewBtn" class="tab">Vecka</button>
      <button id="alarmViewBtn" class="tab">Alarm</button>
    </div>
  </footer>

  <!-- Alarm-ljud -->
  <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

  <!-- App-logik -->
  <script type="module">
    // -------- Firebase imports --------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut,
      GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, query, where, orderBy,
      serverTimestamp, onSnapshot, doc, getDoc, getDocs, setDoc,
      enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-messaging.js";

    console.log("QJ loaded");

    // -------- Config --------
    const firebaseConfig = {
      apiKey: "AIzaSyB2le8k0FJkvVypBQw8Ty9vFVKYQPjUMFc",
      authDomain: "queerjournal-1cc9d.firebaseapp.com",
      projectId: "queerjournal-1cc9d",
      storageBucket: "queerjournal-1cc9d.firebasestorage.app",
      messagingSenderId: "53325952423",
      appId: "1:53325952423:web:24837ecc436332e436b282",
      measurementId: "G-0T6JCFJCFZ"
    };

    // -------- Init --------
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Offline cache
    enableIndexedDbPersistence(db).catch(()=>{/* redan aktiv / inget st√∂d */});

    // (valfritt) Cloud Messaging
    let messaging = null;
    try { messaging = getMessaging(app); } catch {}

    // -------- UI refs --------
    const emailEl = document.getElementById('emailInput');
    const passEl  = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const googleBtn = document.getElementById('googleBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutTop = document.getElementById('logoutTop');
    const resetBtn  = document.getElementById('resetBtn');

    const authSection  = document.getElementById('authSection');
    const noteSection  = document.getElementById('noteSection');
    const notesSection = document.getElementById('notesSection');
    const notesList    = document.getElementById('notesList');

    const userChip  = document.getElementById('userChip');
    const userName  = document.getElementById('userName');
    const userPhoto = document.getElementById('userPhoto');

    const adminMenu = document.getElementById('adminMenu');
    const adminOut  = document.getElementById('adminOut');

    const dateInput=document.getElementById('dateInput');
    const timeInput=document.getElementById('timeInput');
    const moodInput=document.getElementById('moodInput');
    const tagsInput=document.getElementById('tagsInput');
    const contentInput=document.getElementById('contentInput');
    const imageInput=document.getElementById('imageInput');
    const alarmCheck=document.getElementById('alarmCheck');

    const saveBtn=document.getElementById('saveBtn');
    const clearBtn=document.getElementById('clearBtn');

    // -------- Helpers --------
    const today=()=> new Date().toISOString().slice(0,10);
    const now=()=> new Date().toTimeString().slice(0,5);
    dateInput.value=today(); timeInput.value=now();

    if ("Notification" in window && Notification.permission!=="granted"){
      Notification.requestPermission();
    }

    const CACHE_KEY="qj.cached.notes.v2";
    const cacheSet=(arr)=>localStorage.setItem(CACHE_KEY,JSON.stringify(arr));
    const cacheGet=()=>{try{return JSON.parse(localStorage.getItem(CACHE_KEY)||"[]");}catch{return [];}};

    // -------- Handlers --------
    registerBtn.onclick = async () => {
      try{
        const cred = await createUserWithEmailAndPassword(auth, emailEl.value, passEl.value);
        await ensureUserDoc(cred.user);
      }catch(e){ alert(e.message); }
    };
    loginBtn.onclick = async () => {
      try{
        await signInWithEmailAndPassword(auth, emailEl.value, passEl.value);
      }catch(e){ alert(e.message); }
    };
    googleBtn.onclick = async () => {
      try{
        const provider = new GoogleAuthProvider();
        const res = await signInWithPopup(auth, provider);
        await ensureUserDoc(res.user);
      }catch(e){ alert(e.message); }
    };
    const doLogout = () => signOut(auth);
    logoutBtn.onclick  = doLogout;
    logoutTop.onclick  = doLogout;

    // Gl√∂mt l√∂senord
    resetBtn.onclick = async () => {
      const email = (emailEl.value || '').trim();
      if (!email) return alert("Skriv in din e-post f√∂rst, s√• skickar jag en √•terst√§llningsl√§nk.");
      try {
        await sendPasswordResetEmail(auth, email);
        alert("√Öterst√§llningsl√§nk skickad! Kolla din e-post.");
      } catch (e) {
        alert("Kunde inte skicka √•terst√§llningsl√§nk: " + e.message);
      }
    };

    // -------- User doc --------
    async function ensureUserDoc(user){
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      const base = {
        uid: user.uid,
        email: user.email || null,
        displayName: user.displayName || null,
        photoURL: user.photoURL || null,
        updatedAt: serverTimestamp(),
      };
      if (!snap.exists()){
        await setDoc(ref, { ...base, createdAt: serverTimestamp(), tokens: [] });
      } else {
        await setDoc(ref, base, { merge: true });
      }
    }

    // -------- (valfritt) Push --------
    async function setupPush(user){
      if (!messaging) return;
      try{
        const vapidKey = "BCfqKb1YvwfuGzZLJJ2ETaBdGLwWYVoeAB1zSIyA7CxvTelJqJCrwGL5Z5XjV2rRgLohBuWGYOmAaIHZtPTxbDk";
        const permission = await Notification.requestPermission();
        if (permission !== "granted") return;

        const token = await getToken(messaging, { vapidKey });
        if (!token) return;

        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        const tokens = (snap.exists() && Array.isArray(snap.data().tokens)) ? snap.data().tokens : [];
        if (!tokens.includes(token)){
          tokens.push(token);
          await setDoc(ref, { tokens, updatedAt: serverTimestamp() }, { merge:true });
        }

        onMessage(messaging, (payload)=>{
          const body = payload?.notification?.body || "Ny notis";
          new Notification(payload?.notification?.title || "Queer Journal", {
            body, icon: "./android-chrome-192x192.png"
          });
        });
      }catch(e){ console.warn("Push setup failed:", e); }
    }

    // -------- Admin & block --------
    async function checkAdmin(user){
      try{
        const ref = doc(db, "admins", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists() && snap.data()?.role === "superadmin") {
          adminMenu.style.display = 'block';
          adminOut.textContent = "Superadmin inloggad üöÄ";
          return true;
        }
      }catch(e){ console.warn("Admin check failed:", e); }
      adminMenu.style.display = 'none';
      adminOut.textContent = "";
      return false;
    }
    async function findUidByEmail(email) {
      const qy = query(collection(db, "users"), where("email", "==", email));
      const s = await getDocs(qy);
      if (s.empty) return null;
      return s.docs[0].id || s.docs[0].data().uid;
    }
    async function sendWarning(targetUid, reason) {
      const admin = auth.currentUser;
      await addDoc(collection(db, "warnings"), {
        targetUid,
        reason: reason || null,
        by: admin?.uid || null,
        at: serverTimestamp()
      });
    }
    async function blockUser(targetUid, reason) {
      const admin = auth.currentUser;
      await setDoc(doc(db, "blocks", targetUid), {
        blocked: true,
        reason: reason || null,
        by: admin?.uid || null,
        at: serverTimestamp()
      }, { merge: true });
    }
    async function checkBlocked(user) {
      try {
        const snap = await getDoc(doc(db, "blocks", user.uid));
        if (snap.exists() && snap.data()?.blocked) {
          alert("Ditt konto √§r blockerat. Kontakta support om du tror detta √§r fel.");
          await signOut(auth);
          return true;
        }
      } catch(e) { console.warn("Block check failed:", e); }
      return false;
    }

    // Admin-knappar
    document.getElementById("btnWarn").onclick = async () => {
      const emailOrUid = prompt("Vem vill du varna? Ange email eller uid:");
      if (!emailOrUid) return;
      const reason = prompt("Ange orsak (valfritt):") || "";
      let targetUid = emailOrUid.trim();
      if (targetUid.includes("@")) {
        const found = await findUidByEmail(targetUid);
        if (!found) return alert("Hittar ingen anv√§ndare med den e-posten.");
        targetUid = found;
      }
      try {
        await sendWarning(targetUid, reason);
        adminOut.textContent = `Varning skickad till ${targetUid}`;
      } catch(e) { alert("Kunde inte skicka varning: " + e.message); }
    };
    document.getElementById("btnBlock").onclick = async () => {
      const emailOrUid = prompt("Vilken anv√§ndare ska blockeras? Ange email eller uid:");
      if (!emailOrUid) return;
      const reason = prompt("Orsak till blockering (valfritt):") || "";
      let targetUid = emailOrUid.trim();
      if (targetUid.includes("@")) {
        const found = await findUidByEmail(targetUid);
        if (!found) return alert("Hittar ingen anv√§ndare med den e-posten.");
        targetUid = found;
      }
      if (!confirm(`Blockera anv√§ndare ${targetUid}?`)) return;
      try {
        await blockUser(targetUid, reason);
        adminOut.textContent = `Anv√§ndare blockerad: ${targetUid}`;
      } catch(e) { alert("Kunde inte blockera: " + e.message); }
    };

    // -------- Live-lyssning --------
    let unsubscribe = null;
    let currentNotes = [];
    function startNotesListener(uid){
      if (unsubscribe) { try { unsubscribe(); } catch {} }
      const qy = query(
        collection(db,"notes"),
        where("uid","==",uid),
        orderBy("date","desc")
      );
      unsubscribe = onSnapshot(qy, { includeMetadataChanges:true }, (snap)=>{
        const arr=[];
        snap.forEach(d=>arr.push(d.data()));
        currentNotes = arr.sort((a,b)=> (b.date+b.time).localeCompare(a.date+a.time));
        cacheSet(currentNotes);
        render();
        rescheduleAll();
      }, (err)=>{
        console.warn("Snapshot error:", err);
        currentNotes = cacheGet();
        render();
      });
    }

    // -------- Auth state --------
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        // visa app
        authSection.style.display='none';
        noteSection.style.display='block';
        notesSection.style.display='block';
        logoutBtn.style.display='';
        logoutTop.style.display='';
        resetBtn.style.display='none';
        userChip.style.display='';
        userName.textContent = user.displayName || user.email || 'Inloggad';
        userPhoto.src = user.photoURL || './android-chrome-192x192.png';

        // sp√§rrkoll
        const isBlocked = await checkBlocked(user);
        if (isBlocked) return;

        await ensureUserDoc(user);
        startNotesListener(user.uid);
        setupPush(user);
        checkAdmin(user);
      }else{
        // visa inloggning
        authSection.style.display='block';
        noteSection.style.display='none';
        notesSection.style.display='none';
        logoutBtn.style.display='none';
        logoutTop.style.display='none';
        resetBtn.style.display='';
        userChip.style.display='none';
        adminMenu.style.display='none';
        if (unsubscribe) { try { unsubscribe(); } catch {} }
      }
    });

    // -------- Spara anteckning --------
    saveBtn.onclick = async () => {
      const user = auth.currentUser;
      if(!user){alert("Logga in f√∂rst.");return;}
      const file=imageInput.files[0];
      const readImage=(f)=>new Promise(res=>{
        if(!f)return res(null);
        const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f);
      });
      const imgData = await readImage(file);
      const tags = (tagsInput.value||"").split(',').map(s=>s.trim()).filter(Boolean);

      const note = {
        uid:user.uid,
        date:dateInput.value,
        time:timeInput.value,
        mood:moodInput.value,
        tags,
        content:contentInput.value.trim(),
        image:imgData || null,
        alarm:Boolean(alarmCheck.checked),
        createdAt: serverTimestamp()
      };

      try{
        await addDoc(collection(db,"notes"), note);
        clearForm();
      }catch(e){alert(e.message);}
    };

    function clearForm(){
      moodInput.value="";
      tagsInput.value="";
      contentInput.value="";
      imageInput.value="";
      alarmCheck.checked=false;
      dateInput.value=today();
      timeInput.value=now();
    }

    // -------- Vyer & rendering --------
    let viewMode="list";
    const setActive=id=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    };
    document.getElementById('listViewBtn').onclick=()=>{setActive('listViewBtn');viewMode='list';render();};
    document.getElementById('dayViewBtn').onclick =()=>{setActive('dayViewBtn');viewMode='day';render();};
    document.getElementById('weekViewBtn').onclick=()=>{setActive('weekViewBtn');viewMode='week';render();};
    document.getElementById('alarmViewBtn').onclick=()=>{setActive('alarmViewBtn');viewMode='alarm';render();};

    function render() {
      if (!currentNotes.length) {
        notesList.innerHTML = '<div class="empty">Inga anteckningar.</div>';
        return;
      }
      let list = [...currentNotes];

      if (viewMode === 'day') {
        const iso = today();
        list = list.filter(n => n.date === iso);
      } else if (viewMode === 'week') {
        const d = new Date();
        const day = (d.getDay() || 7);
        const mon = new Date(d); mon.setDate(d.getDate() - day + 1);
        const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
        const a = mon.toISOString().slice(0,10), b = sun.toISOString().slice(0,10);
        list = list.filter(n => n.date >= a && n.date <= b);
      } else if (viewMode === 'alarm') {
        list = list.filter(n => n.alarm);
      }

      notesList.innerHTML = '';
      list.forEach(n => {
        const div = document.createElement('div');
        div.className = 'entry';
        const title =
          (n.mood ? `<span class="emoji">${n.mood.split(' ')[0]}</span>` : '') +
          (n.content?.split('\n')[0]?.slice(0,40) || 'Anteckning');
        div.innerHTML = `
          <strong>${title}</strong><br>
          <span class="muted">${n.date} ${n.time || ''} ${n.alarm ? '‚è∞' : ''}</span>
          <p>${(n.content || '').replace(/\n/g,'<br>')}</p>
          ${(n.tags || []).map(t => `<span class="badge">#${t}</span>`).join(' ')}
          ${n.image ? `<img class="thumb" src="${n.image}" alt="bild">` : ''}
        `;
        notesList.appendChild(div);
      });
    }

    // -------- Alarm (klient) --------
    function scheduleAlarm(note) {
      if (!note.date || !note.time) return;
      const dt = new Date(note.date + 'T' + note.time);
      const diff = dt.getTime() - Date.now();
      if (diff <= 0) return;
      setTimeout(() => triggerAlarm(note), diff);
    }
    function triggerAlarm(note) {
      const audio = document.getElementById('alarmSound');
      audio?.play().catch(()=>{});
      const body = note.content || 'Dags att kolla din anteckning!';
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('‚è∞ Alarm!', { body, icon: './android-chrome-192x192.png' });
      } else {
        alert('‚è∞ ' + body);
      }
    }
    function rescheduleAll() {
      (currentNotes || []).filter(n => n.alarm).forEach(scheduleAlarm);
    }

    // -------- Tema --------
    document.getElementById('darkToggle').onclick = () =>
      document.body.classList.toggle('dark');

    // -------- Service Worker (PWA) --------
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js', { scope: './' })
        .catch(err => console.warn('SW fail:', err));
    }
  </script>
</body>
</html>

